extends ./layout

block task-content
    div(ng-controller="CreateUpdateTaskCtrl", ng-init="init('#{id}')")
        form(role="form", ng-submit="submit()")
            .well
                .form-group
                    label(for="name") Task Name:
                        span.required  *
                    input.form-control(ng-model="task.name", placeholder="Task Name", required="required")
                .form-group
                    label(for="description") Task Description:
                        span.required  *
                    textarea.form-control(ng-model="task.description", placeholder="Task Description", required="required")
                .form-group
                    .row
                        .col-md-3
                            label(for="external_id") Feature TFS ID:
                                span.required  *
                            input.form-control(ng-model="task.external_id", placeholder="12345", required="required")
                        .col-md-9
                            label(for="availability") Availability:
                            .row
                                .col-md-12
                                    .radio
                                        label
                                            input(type="radio", name="availability", value="0", ng-model="task.availability.availability_type")
                                            | General
                            .row
                                .col-md-3
                                    .radio
                                        label
                                            input(type="radio", name="availability", value="1", ng-model="task.availability.availability_type")
                                            | Partner Specific
                                .col-md-9
                                    input.form-control(type="hidden", ui-select2="ui.availability.partners.select", ng-model="task.availability.partners", placeholder="Partners", ng-disabled="task.availability.availability_type == 0")
            .well
                label Inputs:
                    span.required  *
                .well(ng-repeat="input in task.inputs track by $index")
                    .form-group(id="input{{$index + 1}}")
                        .row
                            .col-md-6
                                label Input {{alphaOrder(task.inputs, input)}}:
                            .col-md-6.text-right
                                a(ng-href="#input{{task.inputs.length}}", ng-click="task.$input.copy(input)") Copy
                                |  |  
                                a(ng-href="#input{{task.inputs.length - 1}}", ng-click="task.$input.remove(input)") Remove Input
                        table.table.table-striped(style="margin-bottom: 0px;")
                            thead
                                th Condition
                                th Enter from UI
                                th Enter via API
                                th Generated by Task
                                th Note
                                th
                            tbody
                                tr(ng-repeat="condition in input.conditions track by $index")
                                    td
                                        include partial_condition_icon
                                        |  
                                        a(ng-click="task.$input.createUpdateCondition(input, condition)") {{condition.name}}
                                    td
                                        div.no-wrap(ng-repeat="input in condition.ui.input track by $index")
                                            | {{input}}
                                    td
                                        div.no-wrap(ng-repeat="input in condition.api.input track by $index")
                                            | {{input}}
                                    td
                                        img.loader(src="/public/images/loader.gif", ng-show="!condition.producerTasksLoaded")
                                        div(ng-repeat="producerTask in getProducerTasks(condition)")
                                            a(ng-href="/task/view/{{producerTask.id}}", target="_blank", popover="{{producerTask.description}}", popover-trigger="mouseenter", popover-popup-delay="300", popover-placement="right") {{producerTask.name}}
                                    td
                                        span(popover="{{condition.note}}", popover-trigger="mouseenter", popover-popup-delay="300", popover-placement="right") {{trimText(condition.note, 25)}}
                                    td.col-td-min
                                        a(ng-click="task.removeCondition(input.conditions, condition)")
                                            span.glyphicon.glyphicon-remove
                    .form-group
                        .row
                            .col-md-3
                                input#input-add-condition.form-control(ng-model="input.findConditionCriteria", typeahead="condition as condition.name for condition in task.findCondition($viewValue)", typeahead-on-select="task.$input.pushCondition(input, $item)", placeholder="Search for condition")
                            .col-md-9
                .form-group
                    span.glyphicon.glyphicon-plus
                    |  
                    a(ng-click="task.$input.add()") Add Input
            .well
                label Outputs:
                    span.required  *
                .well(ng-repeat="output in task.outputs track by $index")
                    .form-group(id="output{{$index + 1}}")
                        .row
                            .col-md-6
                                label Output {{alphaOrder(task.outputs, output)}}:
                            .col-md-6.text-right
                                a(ng-href="#output{{task.outputs.length}}", ng-click="task.$output.copy(output)") Copy
                                |  |  
                                a(ng-href="#output{{task.outputs.length - 1}}", ng-click="task.$output.remove(output)") Remove Output
                        table.table.table-striped
                            thead
                                th Condition
                                th Affects Task
                                th Displayed on UI
                                th Used in API
                                th Used as Input for Task
                                th Note
                                th
                            tbody
                                tr(ng-repeat="condition in output.conditions track by $index")
                                    td
                                        include partial_condition_icon
                                        |  
                                        a(ng-click="task.$output.createUpdateCondition(output, condition)") {{condition.name}}
                                    td
                                        div(ng-repeat="affect in condition.affects")
                                            a(ng-if="!affect.task.is_transient", ng-href="/task/view/{{affect.task.id}}", target="_blank", popover="{{affect.description}}", popover-trigger="mouseenter", popover-popup-delay="300", popover-placement="right") {{affect.task.name}}
                                            span(ng-if="affect.task.is_transient", popover="{{affect.description}}", popover-trigger="mouseenter", popover-popup-delay="300", popover-placement="right") {{affect.task.name}}
                                    td
                                        div.no-wrap(ng-repeat="output in condition.ui.output track by $index")
                                            | {{output}}
                                    td
                                        div.no-wrap(ng-repeat="output in condition.api.output track by $index")
                                            | {{output}}
                                    td
                                        img.loader(src="/public/images/loader.gif", ng-show="!condition.consumerTasksLoaded")
                                        div(ng-repeat="consumerTask in getConsumerTasks(condition)")
                                            a(ng-href="/task/view/{{consumerTask.id}}", target="_blank", popover="{{consumerTask.description}}", popover-trigger="mouseenter", popover-popup-delay="300", popover-placement="right") {{consumerTask.name}}
                                    td
                                        span(popover="{{condition.note}}", popover-trigger="mouseenter", popover-popup-delay="300", popover-placement="right") {{trimText(condition.note, 25)}}
                                    td.col-td-min
                                        a(ng-click="task.removeCondition(output.conditions, condition)")
                                            span.glyphicon.glyphicon-remove
                    .form-group
                        .row
                            .col-md-3
                                input#input-add-condition.form-control(ng-model="output.findConditionCriteria", typeahead="condition as condition.name for condition in task.findCondition($viewValue)", typeahead-on-select="task.$output.pushCondition(output, $item)", placeholder="Search for condition")
                            .col-md-9
                    br
                .form-group
                    span.glyphicon.glyphicon-plus
                    |  
                    a(ng-click="task.$output.add()") Add Output
            br
            input(type="submit", value="Submit", ng-disabled="!validate()").btn.btn-primary
            a.btn.btn-default(type="button", href="/") Cancel